<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>USDT Transfer Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>USDT Token Transfer Events</h1>
  <button id="refresh-btn">Reload Events</button>
  <div id="status"></div>
  <div id="events-list">Loading...</div>

  <script>
    const eventsList = document.getElementById('events-list');
    const status = document.getElementById('status');
    const refreshBtn = document.getElementById('refresh-btn');

    // Convert raw BigInt value to human-readable token amount string
    function formatTokenAmount(valueRaw, decimals = 6) {
      const bigValue = BigInt(valueRaw);
      const divisor = 10n ** BigInt(decimals);
      const whole = bigValue / divisor;
      const fraction = bigValue % divisor;
      const fractionStr = fraction.toString().padStart(decimals, '0').replace(/0+$/, '');
      return fractionStr ? `${whole.toString()}.${fractionStr}` : whole.toString();
    }

    // Format event arguments for display
    function formatTransferEvent(eventArgs) {
      const from = eventArgs[0];
      const to = eventArgs[1];
      const amountRaw = eventArgs[2];
      const amountFormatted = formatTokenAmount(amountRaw);

      return `
        <div class="event-item">
          <div><strong>From:</strong> <span class="address">${from}</span></div>
          <div><strong>To:</strong> <span class="address">${to}</span></div>
          <div><strong>Amount:</strong> ${amountFormatted} USDT</div>
        </div>
      `;
    }

    async function loadEvents() {
      status.textContent = 'Fetching events...';
      try {
        const res = await fetch('/events');
        const events = await res.json();

        if (!events.length) {
          eventsList.innerHTML = '<p class="no-events">No events found.</p>';
          status.textContent = '';
          return;
        }

        const html = events.map(eventStr => {
          // Extract JSON array from event string: `Event Transfer: [...]`
          const argsMatch = eventStr.match(/\[(.*)\]/);
          if (!argsMatch) return '';
          const args = JSON.parse(`[${argsMatch[1]}]`);
          return formatTransferEvent(args);
        }).join('');

        eventsList.innerHTML = html;
        status.textContent = `Number of events: ${events.length}`;
      } catch (err) {
        eventsList.innerHTML = '<p class="error">Error fetching events</p>';
        status.textContent = '';
        console.error(err);
      }
    }

    refreshBtn.addEventListener('click', loadEvents);

    loadEvents();

    setInterval(loadEvents, 10000);
  </script>
</body>
</html>
